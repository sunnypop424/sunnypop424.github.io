(()=>{"use strict";const e={HERO:7,LEGEND:11,RELIC:15,ANCIENT:17},t={HERO:[10],LEGEND:[10,14],RELIC:[10,14,17,18,19,20],ANCIENT:[10,14,17,18,19,20]},o={dealer:new Set(["atk","add","boss"]),support:new Set(["brand","allyDmg","allyAtk"])},r={boss:1,add:1,atk:1,brand:0,allyDmg:0,allyAtk:0},n={boss:[0,.078,.156,.244,.313,.391],add:[0,.06,.119,.187,.239,.299],atk:[0,.029,.067,.105,.134,.172]},l={brand:[0,.167,.334,.501,.668,.835],allyAtk:[0,.13,.26,.39,.52,.65],allyDmg:[0,.052,.104,.156,.208,.26]};function i(e){const t={...r};return e?(Object.keys(t).forEach(o=>{const n=e[o],l="number"===typeof n?n:Number(n);t[o]=Number.isFinite(l)&&l>=0?l:r[o]}),t):t}function s(e,t,o){const r=Math.max(0,Math.min(5,Number(o)||0));return"dealer"===e&&n[t]?n[t][r]||0:"support"===e&&l[t]?l[t][r]||0:r}function c(e,t,r){const n=i(r||{});let l=0;const c=(e,r)=>{var i;if(!e||!r)return;if(t&&!function(e,t){const r=null===o||void 0===o?void 0:o[e];return!r||(Array.isArray(r)?r.includes(t):r&&"function"===typeof r.has?r.has(t):!r||"object"!==typeof r||!!r[t])}(t,e))return;const c=s(t,e,r),a=null!==(i=n[e])&&void 0!==i?i:0;l+=c*a};return c(e.o1k,e.o1v),c(e.o2k,e.o2v),l}function*a(e,t){const o=e.length;if(t>o)return;const r=Array.from({length:t},(e,t)=>t);for(;;){yield r.map(t=>e[t]);let n=t-1;for(;n>=0&&r[n]===o-t+n;)n--;if(n<0)break;r[n]++;for(let e=n+1;e<t;e++)r[e]=r[e-1]+1}}function u(e,o,r,n){const l=e.reduce((e,t)=>{var o;return e+(null!==(o=t.will)&&void 0!==o?o:0)},0),i=e.reduce((e,t)=>{var o;return e+(null!==(o=t.point)&&void 0!==o?o:0)},0),s=function(e,o){return t[e].filter(e=>o>=e)}(o,i),a=e.reduce((e,t)=>e+c(t,r,n),0);return{totalWill:l,totalPoint:i,thr:s,roleSum:a,score:1e7*s.length+1e4*i+10*(5e3-l)+a-e.length}}function h(o,r,n,l,s,c,h){const d=e[r],f=i(l),m=[],g=Math.min(4,o.length);for(let e=0;e<=g;e++)if(0!==e)for(const t of a(o,e)){h&&h(1);const e=t.reduce((e,t)=>e+(t.will||0),0);if(e>d)continue;const{totalPoint:o,thr:l,roleSum:i,score:s}=u(t,r,n,f);m.push({list:t,totalWill:e,totalPoint:o,thr:l,roleSum:i,score:s})}else m.push({list:[],totalWill:0,totalPoint:0,thr:[],roleSum:0,score:0});let p;if(m.sort((e,t)=>t.score-e.score),c){const e=Math.min(...t[r]),o=null!==s&&void 0!==s?s:e;p=m.filter(e=>e.totalPoint>=o&&e.thr.length>0&&e.list.length>0)}else p=null!=s?m.filter(e=>e.totalPoint===s&&e.list.length>0):m.filter(e=>e.thr.length>0&&e.list.length>0);return 0===p.length?[{list:[],totalWill:0,totalPoint:0,thr:[],roleSum:0,score:0}]:p}function d(e,t){const o=i(t),r={atk:0,add:0,boss:0};for(const i of e||[])for(const e of i.list||[])e.o1k&&r.hasOwnProperty(e.o1k)&&(r[e.o1k]+=e.o1v||0),e.o2k&&r.hasOwnProperty(e.o2k)&&(r[e.o2k]+=e.o2v||0);const n=s("dealer","atk",r.atk),l=s("dealer","add",r.add),c=s("dealer","boss",r.boss);return(1+n*o.atk)*(1+l*o.add)*(1+c*o.boss)}const f=e=>{var t;return null!==e&&void 0!==e&&null!==(t=e.thr)&&void 0!==t&&t.length?Math.max(...e.thr):0},m=e=>Math.min(...t[e]),g=()=>{var e,t,o;return null!==(e=null===(t=globalThis.performance)||void 0===t||null===(o=t.now)||void 0===o?void 0:o.call(t))&&void 0!==e?e:Date.now()},p=e=>new Promise(t=>setTimeout(t,e));function v(e,t){for(const o of e.list)if(t.has(o.id))return!0;return!1}const S=(e,t)=>{const o=f(e),r=f(t);return o!==r?r-o:e.totalPoint!==t.totalPoint?t.totalPoint-e.totalPoint:e.roleSum!==t.roleSum?t.roleSum-e.roleSum:e.totalWill-t.totalWill};async function b(e){let{cores:t,pool:o,role:r,weights:n,perCoreLimit:l,emitOverall:i}=e;const s=o.length,c=Math.min(4,s),a=Array.from({length:c},(e,t)=>((e,t)=>{let o=1;for(let r=1;r<=t;r++)o=o*(e-r+1)/r;return Math.floor(o)})(s,t+1)).reduce((e,t)=>e+t,0),u=a*t.length;let d=0;const f=[],m={coreIndex:0,coreCount:t.length,coreDone:0,coreTotal:0,t0:0},v=()=>{var e;d+=1,m.coreDone+=1;const o=g()-m.t0,r=o>=250&&m.coreDone>=Math.min(1e3,.05*m.coreTotal),n=r?m.coreDone/(o/1e3):null,l=r&&n?1e3*Math.max(0,(m.coreTotal-m.coreDone)/n):null;null===i||void 0===i||i({type:"progress",phase:"gen",label:`\ud6c4\ubcf4 \uc0dd\uc131 \uc911\u2026 (${(null===(e=t[m.coreIndex-1])||void 0===e?void 0:e.name)||`\ucf54\uc5b4 ${m.coreIndex}`})`,indeterminate:!1,done:d,total:u,coreIndex:m.coreIndex,coreCount:m.coreCount,coreDone:m.coreDone,coreTotal:m.coreTotal,rate:n,elapsedMs:o,etaMs:l})};for(let b=0;b<t.length;b++){const e=t[b];m.coreIndex=b+1,m.coreDone=0,m.coreTotal=a,m.t0=g(),null===i||void 0===i||i({type:"progress",phase:"gen",label:`\ud6c4\ubcf4 \uc0dd\uc131 \uc911\u2026 (${e.name||`\ucf54\uc5b4 ${m.coreIndex}`})`,indeterminate:!1,done:d,total:u,coreIndex:m.coreIndex,coreCount:m.coreCount,coreDone:m.coreDone,coreTotal:m.coreTotal},!0),await p(0);const s=h(o,e.grade,r,n,e.minThreshold,e.enforceMin,v).filter(e=>e.list.length>0&&e.thr.length>0).sort(S).slice(0,l);f[b]=s,null===i||void 0===i||i({type:"progress",phase:"gen",label:`\ud6c4\ubcf4 \uc0dd\uc131 \uc911\u2026 (${e.name||`\ucf54\uc5b4 ${m.coreIndex}`})`,indeterminate:!1,done:d,total:u,coreIndex:m.coreIndex,coreCount:m.coreCount,coreDone:m.coreTotal,coreTotal:m.coreTotal},!0),await p(0)}return{candidatesPerCore:f,totalGenAll:u,doneCombos:d}}async function k(e){let{cores:t,pool:o,role:r,weights:n,perCoreLimit:l,emit:i}=e;const s=t.map((e,t)=>t),c=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,o=0;return function(r){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const l=g();(n||l-o>=t)&&(o=l,e(r))}}(i,24),{candidatesPerCore:a}=await b({cores:t,pool:o,role:r,weights:n,perCoreLimit:l,emitOverall:c}),u=a;let h=0;const p=function(){h++,c({type:"progress",phase:"search",label:"\ucd5c\uc801 \ubc30\uce58 \ud0d0\uc0c9 \uc911\u2026",indeterminate:!0,pulse:h},arguments.length>0&&void 0!==arguments[0]&&arguments[0])};p(!0);const S={list:[],totalWill:0,totalPoint:0,thr:[],roleSum:0,score:0};function k(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Set,l=null;const i=new Set;return function c(a,h,g,S,b,k,y,T){var P;if(p(),a===s.length){for(const r of e){var w;const e=null!==(w=t[r].minThreshold)&&void 0!==w?w:m(t[r].grade);if(f(h[r])<e)return}const o="dealer"===r?d(h.filter(e=>e&&e.list&&e.list.length>0),n):null,i={picks:h.map(e=>e),sumThr:g,sumPoint:S,sumWill:b,roleSum:k,thrVec:y.slice(),ptVec:T.slice(),globalScore:o};return void(function(e,t,o){if(!t)return!0;if("dealer"===o){if(e.globalScore!==t.globalScore)return e.globalScore>t.globalScore;if(e.sumThr!==t.sumThr)return e.sumThr>t.sumThr;for(let o=0;o<e.thrVec.length;o++)if(e.thrVec[o]!==t.thrVec[o])return e.thrVec[o]>t.thrVec[o];if(e.sumPoint!==t.sumPoint)return e.sumPoint>t.sumPoint;for(let o=0;o<e.ptVec.length;o++)if(e.ptVec[o]!==t.ptVec[o])return e.ptVec[o]>t.ptVec[o];return e.roleSum!==t.roleSum?e.roleSum>t.roleSum:e.sumWill!==t.sumWill&&e.sumWill<t.sumWill}if(e.sumThr!==t.sumThr)return e.sumThr>t.sumThr;for(let r=0;r<e.thrVec.length;r++)if(e.thrVec[r]!==t.thrVec[r])return e.thrVec[r]>t.thrVec[r];if(e.sumPoint!==t.sumPoint)return e.sumPoint>t.sumPoint;for(let r=0;r<e.ptVec.length;r++)if(e.ptVec[r]!==t.ptVec[r])return e.ptVec[r]>t.ptVec[r];return e.roleSum!==t.roleSum?e.roleSum>t.roleSum:e.sumWill!==t.sumWill&&e.sumWill<t.sumWill}(i,l,r)&&(l=i))}const V=s[a],C=e.has(V),W=C?null!==(P=t[V].minThreshold)&&void 0!==P?P:m(t[V].grade):-1/0;if(o.has(V))return void c(a+1,h,g,S,b,k,y,T);const D=u[a]||[];for(const e of D){const t=f(e);if(C&&t<W)continue;if(v(e,i))continue;e.list.forEach(e=>i.add(e.id));const o=h[V];h[V]=e,y[a]=t,T[a]=e.totalPoint,c(a+1,h,g+t,S+e.totalPoint,b+e.totalWill,k+e.roleSum,y,T),e.list.forEach(e=>i.delete(e.id)),h[V]=o,y[a]=0,T[a]=0}C||c(a+1,h,g,S,b,k,y,T)}(0,t.map(()=>S),0,0,0,0,Array(s.length).fill(0),Array(s.length).fill(0)),l}const y=t.map((e,t)=>e.enforceMin?t:-1).filter(e=>-1!==e),T=new Set(y),P=k(T);if(P)return{picks:P.picks,score:"dealer"===r?P.globalScore:void 0};if(s.length>0){const e=s[s.length-1];if(T.has(e)){const t=k(new Set([...T].filter(t=>t!==e)),new Set([e]));if(t){const o=t.picks.map((t,o)=>o===e?S:t||S),l="dealer"===r?d(o.filter(e=>e&&e.list&&e.list.length>0),n):void 0;return{picks:o,score:l}}}}const w=new Set;for(const d of y){var V;const e=null!==(V=t[d].minThreshold)&&void 0!==V?V:m(t[d].grade),o=s.indexOf(d);(u[o]||[]).some(t=>f(t)>=e)||w.add(d)}const C=k(new Set(y.filter(e=>!w.has(e))));if(C){const e=C.picks.map((e,t)=>w.has(t)?S:e||S),t="dealer"===r?d(e.filter(e=>e&&e.list&&e.list.length>0),n):void 0;return{picks:e,score:t}}return{picks:t.map(()=>S)}}globalThis.onmessage=async e=>{const{type:t="run",cores:o,gems:r,role:n,weights:l,perCoreLimit:s}=e.data,c=e=>globalThis.postMessage(e);try{if("kickoff"===t)return;c({type:"result",...await k({cores:o,pool:r,role:n,weights:i(l),perCoreLimit:s,emit:c})})}catch(a){console.error("Worker error:",a),c({type:"error",error:String((null===a||void 0===a?void 0:a.message)||a)})}}})();
//# sourceMappingURL=290.7f8a6495.chunk.js.map